---
title: "Socioeconomic Disparities in Chronic Disease Prevalence Among U.S. Adults"
author: "Chayce Reed"
date: "2026-01-25"
output:
  pdf_document: default
  html_document: default
subtitle: How does socioeconomic status relate to the likelihood of having obesity?
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Load Libraries

```{r}
library(tidyverse)
library(haven) 
library(lotr)
library(gt)
```

## Configuration & Setup

```{r}
# lets declare the filepath to our nhanes data once here
# use paste0() to avoid the path getting cutoff in knitted pdf
file_path <- paste0("/Users/chayce/Documents/Dartmouth College",
                    "/MS in Health Data Science/01 - Courses",
                    "/HSE 721 - Data Wrangling/06 - Final Project/Data/")

# lets declare the plot aesthetics once here, for consustency
# and so if we want to change it, we only have to change it once
prevalence_palette <- "rivendell"
age_distribution_palette <- "samwise"
alpha = 0.5
size = 2
linetype = 2
nudge_y = 0.02
```


## Load & Read NHANES Data

```{r}
# nhanes 2017-2018 demographic data
# https://wwwn.cdc.gov/nchs/nhanes/search/datapage.aspx?Component=Demographics&CycleBeginYear=2017
# specifically looking at the income-to-poverty, income, education fields
demo <- read_xpt(paste0(file_path, "DEMO_J.xpt")) 

# nhanes 2017-2018 body measures data
# https://wwwn.cdc.gov/nchs/nhanes/search/datapage.aspx?Component=Examination&CycleBeginYear=2017
# specifically looking at the body mass index field
bmi <- read_xpt(paste0(file_path, "BMX_J.xpt"))
```

## Subset Demographic Data

```{r}
# lets subset the demographic data to only include the fields we are interested in
# SEQN = unique respondent identifier, RIAGENDR = gender, RIDAGEYR = age,
# DMDEDUC2 = education level (20+), INDHHIN2 = annual household income
# INDFMPIR = ratio of family income to poverty
demo <- demo[c("SEQN", "RIAGENDR", "RIDAGEYR", "DMDEDUC2", "INDHHIN2", "INDFMPIR")]

# subset to only include adults 20+
demo <- demo[demo$RIDAGEYR >= 20, ]
```

## Subset BMI Data

```{r}
# lets subset the body measures data to only include the fields we are interested in
# # SEQN = unique respondent identifier, BMXBMI = body mass index
bmi <- bmi[c("SEQN", "BMXBMI")]
```

## Summarize & Glimpse Data

```{r}
cat("------- DEMO DATA -------\n") # divider, to clearly differentiate the two df
# lets check the structure of the data, and see how the values are defined
glimpse(demo) 

cat("\n------- BMI DATA -------\n") # divider, to clearly differentiate the two df
# lets check the structure of the data, and see how the values are defined
glimpse(bmi)
```

## Update Rows to Meaningful Values

```{r}
# here, we are going to create new columns with more readable and usable column
# names and values (e.g., RIAGENDR -> gender, 1 -> Male)

cat("------- DEMO DATA -------\n") # divider, to clearly differentiate the two df
# first, lets create a new gender column and update the values from numeric (1, 2)
# to characters (Male, Female), based on the NHANES DEMO_J.doc
demo$gender <- demo$RIAGENDR
demo$gender <- factor(
  case_when(
    demo$RIAGENDR == 1 ~ "Male",
    demo$RIAGENDR == 2 ~ "Female",
    TRUE ~ NA
  ), 
  levels = c("Male", "Female")
)

# we can keep the values, but lets update the column name
demo$age <- demo$RIDAGEYR

# next, lets update the education column and values
# to me, grouping the data into 3 broad categories 
# (Non-High School Graduate, High School Graduate, and Some College or Higher) 
#@ makes the most sense
demo$education <- demo$DMDEDUC2
demo$education <- factor(
  case_when(
    demo$DMDEDUC2 < 3 ~ "Non-High School Graduate",
    demo$DMDEDUC2 == 3 ~ "High School Graduate",
    demo$DMDEDUC2 == 4 ~ "Some College or Higher",
    demo$DMDEDUC2 == 5 ~ "Some College or Higher",
    TRUE ~ NA
  ),
  levels = c("Non-High School Graduate", "High School Graduate", "Some College or Higher")
)

# next, lets group the income column and values
# group into 5 groups, to give us more granularity than education and income ratio
# < 20,000, $20,000-$44,999, $45,000-$74,99, $75,000-$99,999, > $100,000
demo$income <- demo$INDHHIN2
demo$income <- factor(
  case_when(
    demo$INDHHIN2 == 1 ~ "< $20,000",
    demo$INDHHIN2 == 2 ~ "< $20,000",
    demo$INDHHIN2 == 3 ~ "< $20,000",
    demo$INDHHIN2 == 4 ~ "< $20,000",
    demo$INDHHIN2 == 13 ~ "< $20,000",
    demo$INDHHIN2 == 5 ~ "$20,000-$44,999",
    demo$INDHHIN2 == 6 ~ "$20,000-$44,999",
    demo$INDHHIN2 == 7 ~ "$20,000-$44,999",
    demo$INDHHIN2 == 8 ~ "$45,000-$74,999",
    demo$INDHHIN2 == 9 ~ "$45,000-$74,999",
    demo$INDHHIN2 == 10 ~ "$45,000-$74,999",
    demo$INDHHIN2 == 14 ~ "$75,000-$99,999",
    demo$INDHHIN2 == 15 ~ "> $100,000",
    TRUE ~ NA
  ),
  levels = c("< $20,000", "$20,000-$44,999", "$45,000-$74,999", "$75,000-$99,999", "> $100,000")
)

# we can keep the income ratio values as is, but we will also add a new category
# column too
demo$ratio <- demo$INDFMPIR

# now, lets group the income ratios into 3 distinct categories: low income, 
# medium income, and high income
# category thresholds were based on: https://stacks.cdc.gov/view/cdc/112811
demo$ratio_cat <- demo$INDFMPIR
demo$ratio_cat <- factor(
  case_when(
    demo$INDFMPIR < 1.30 ~ "Low Income",
    demo$INDFMPIR < 3.50 ~ "Medium Income",
    demo$INDFMPIR >= 3.50 ~ "High Income",
    TRUE ~ NA
  ),
  levels = c("Low Income", "Medium Income", "High Income")
)

# now lets cleanup the demographics df to only include the new columns
demo <- demo[c("SEQN", "gender", "age", "education", "income", "ratio", "ratio_cat")]
glimpse(demo) # check to make sure it looks ok

# now lets do the same for the bmi df
cat("\n------- BMI DATA -------\n") # divider, to clearly differentiate the two df
# we can keep the bmi values, but rename the column
bmi$bmi <- bmi$BMXBMI

# now, lets group the bmi into distinct categories: underweight, healthy weight,
# overweight, obesity. 
# category threshold were based on: https://www.cdc.gov/bmi/adult-calculator/bmi-categories.html
bmi$bmi_cat <- bmi$BMXBMI
bmi$bmi_cat <- factor(
  case_when(
    bmi$BMXBMI < 18.5 ~ "Underweight",
    bmi$BMXBMI < 25 ~ "Healthy Weight",
    bmi$BMXBMI < 30 ~ "Overweight",
    bmi$BMXBMI >= 30 ~ "Obesity",
    TRUE ~ NA
  ),
  levels = c("Underweight", "Healthy Weight", "Overweight", "Obesity")
)

# lets cleanup the bmi df to use these new columns
bmi <- bmi[c("SEQN", "bmi", "bmi_cat")]
glimpse(bmi) # check to make sure it looks ok
```

## Create Demographic Summary Tables

```{r}
# to create tables for our report, lets use the gt library
# referencing https://r-graph-gallery.com/package/gt.html for help
# first need to make a data frame containing the info we want to display
# for the age summary table, lets include mean, standard deviation, min and max
demo_age_table_df <- data.frame(
    Metric = c("Min", "Mean", "Max", "SD"),
    Age = c(as.character(min(demo$age)),
            as.character(floor(mean(demo$age, rm.na = TRUE))), 
            as.character(max(demo$age)),
            as.character(round(sd(demo$age), 1))
            )
  )

# now we can use gt() to create a formatted table we can use in our report
gt(demo_age_table_df, rowname_col = "Metric")

# now lets create a table to display the count and proportions for each gender
# table() for the counts per gender
demo_gender_table <- table(demo$gender)
demo_gender_male_count <- demo_gender_table[1]
demo_gender_female_count <- demo_gender_table[2]

# prop.table() for the proportions per gender
demo_gender_prop <- round(prop.table(demo_gender_table), 2)
demo_gender_male_prop <- demo_gender_prop[1]
demo_gender_female_prop <- demo_gender_prop[2]

# now lets build the df
demo_gender_table_df <- data.frame(
  Gender = c("Male", "Female"),
  Count = c(demo_gender_male_count, demo_gender_female_count), 
  Female = c(demo_gender_male_prop, demo_gender_female_prop)
)

# finally display it using gt()
gt(demo_gender_table_df, rowname_col = "Gender")
```

## Create BMI Summary Tables

```{r}
# now lets create age and bmi category summary tables for the bmi dataset
bmi_age_table_df <- data.frame(
    Metric = c("Min", "Mean", "Max", "SD"),
    Age = c(as.character(min(bmi$age)),
            as.character(floor(mean(bmi$age, rm.na = TRUE))), 
            as.character(max(bmi$age)),
            as.character(round(sd(bmi$age), 1))
            )
  )

# create our age summary table for the bmi dataset
gt(bmi_age_table_df, rowname_col = "Metric")

# now lets determine the counts per bmi category
bmi_cat_table <- table(bmi$bmi_cat)
bmi_undeweight_count <- bmi_cat_table[1]
bmi_healthy_weight_count <- bmi_cat_table[2]
bmi_over_weight_count <- bmi_cat_table[3]
bmi_obesity_count <- bmi_cat_table[4]

# then the proportions per bmi category
bmi_cat_prop <- round(prop.table(bmi_cat_table), 2)
bmi_undeweight_prop <- bmi_cat_prop[1]
bmi_health_weight_prop <- bmi_cat_prop[2]
bmi_over_weight_prop <- bmi_cat_prop[3]
bmi_obesity_prop <- bmi_cat_prop[4]

# now lets put all the data into a df
bmi_cat_table_df <- data.frame(
  BMI = c("Underweight", "Healthy Weight", "Overweight", "Obesity"),
  Count = c(bmi_undeweight_count, bmi_healthy_weight_count, bmi_over_weight_count, bmi_obesity_count), 
  Proportion = c(bmi_undeweight_prop, bmi_health_weight_prop, bmi_over_weight_prop, bmi_obesity_prop)
)

# finally lets display our table
gt(bmi_cat_table_df, rowname_col = "BMI")
```

## Merged Demographic & BMI Data

```{r}
# now, we can merge our demo and bmi dfs 
# we can merge by SEQN, the unique respondent identifier
demo_bmi <- merge(demo, bmi, by = "SEQN")
head(demo_bmi) # lets check to make sure it worked

# lets compare the number of missing vs non-missing values per column
cat("\nNon-Missing Values per Column:\n")
colSums(!is.na(demo_bmi))
cat("\nMissing Values per Column:\n")
colSums(is.na(demo_bmi))
cat("\nProportion of Missing Values per Column:\n")
round(colSums(is.na(demo_bmi)) / colSums(!is.na(demo_bmi)),2)

# since less than 15% of the data is missing for the income and ratio_cat 
# and only 2% of the data is missing for bmi_cat
# i am comfortable removing these rows from the data
# still, we will first subset the data into three new df
# for income ratio vs bmi, income vs bmi, and education vs bmi
# this is so avoid compounding row removals (for example, we dont care if the 
# income is missing when comparing bmi across education levels, just like we 
# dont need the education level values when comparing bmi across income levels)

# first, lets create our df for income ratio vs bmi
# we will include age, as a potential confounder 
ratio_bmi <- demo_bmi[c("age", "gender", "ratio_cat", "bmi_cat")]
ratio_bmi <- ratio_bmi[!is.na(ratio_bmi$ratio_cat), ]
ratio_bmi <- ratio_bmi[!is.na(ratio_bmi$bmi_cat), ]

# second, lets create our df for income vs bmi
# again, include age, as a potential confounder 
income_bmi <- demo_bmi[c("age", "gender", "income", "bmi_cat")]
income_bmi <- income_bmi[!is.na(income_bmi$income), ]
income_bmi <- income_bmi[!is.na(income_bmi$bmi_cat), ]

# finally, lets create our df for education vs bmi
# including age, as a potential confounder 
education_bmi <- demo_bmi[c("age", "gender", "education", "bmi_cat")]
education_bmi <- education_bmi[!is.na(education_bmi$education), ]
education_bmi <- education_bmi[!is.na(education_bmi$bmi_cat), ]
```
```{r sample-sizes}
# now, lets determine the sample size for each category, to make sure that all 
# category have a sufficient sample size to conduct a reasonable analysis

cat("------- Sample Size: Income Ratio -------") # divider, purely aesthetic
# first, lets view and compare the sample sizes across income ratio categories
cat(paste("\nLow Income Ratio:", sum(ratio_bmi$ratio_cat == "Low Income", na.rm = TRUE)))
cat(paste("\nMediun Income Ratio:", sum(ratio_bmi$ratio_cat == "Medium Income", na.rm = TRUE)))
cat(paste("\nHigh Income Ratio:", sum(ratio_bmi$ratio_cat == "High Income", na.rm = TRUE)))

cat("\n\n------- Sample Size: Income -------") # divider, purely aesthetic
# next, lets view and compare the sample sizes across income levels
cat(paste("\n< $20,000:", sum(income_bmi$income == "< $20,000", na.rm = TRUE)))
cat(paste("\n$20,000-$44,999:", sum(income_bmi$income == "$20,000-$44,999", na.rm = TRUE)))
cat(paste("\n$45,000-$74,999:", sum(income_bmi$income == "$45,000-$74,999", na.rm = TRUE)))
cat(paste("\n$75,000-$99,999:", sum(income_bmi$income == "$75,000-$99,999", na.rm = TRUE)))
cat(paste("\n> $100,000:", sum(income_bmi$income == "> $100,000", na.rm = TRUE)))

cat("\n\n------- Sample Size: Education Level -------") # divider, purely aesthetic
# finally, lets view and compare the sample sizes across education levels
cat(paste("\nNon-High School Graduate:", sum(education_bmi$education == "Non-High School Graduate", na.rm = TRUE)))
cat(paste("\nHigh School Graduate:", sum(education_bmi$education == "High School Graduate", na.rm = TRUE)))
cat(paste("\nSome College or Higher:", sum(education_bmi$education == "Some College or Higher", na.rm = TRUE)))
```

## Create Socioeconomic Factor Summary Tables

```{r}
# now, lets create summary tables for each socioeconomic factor
# starting with education, lets determine the amount of samples per
# education level
demo_education_table <- table(education_bmi$education)
demo_nohs_count <- demo_education_table[1]
demo_hs_count <- demo_education_table[2]
demo_scoh_count <- demo_education_table[3]

# now, we can use prop.table() on the original table to calculate the 
# proportions per education level
demo_education_prop <- round(prop.table(demo_education_table), 2)
demo_nohs_prop <- demo_education_prop[1]
demo_hs_prop <- demo_education_prop[2]
demo_scoh_prop <- demo_education_prop[3]

# lets put the counts and proportions into a df, along with a vector for our education levels
demo_education_table_df <- data.frame(
  Level = c("Non-High School Graduate", "High School Graduate", "Some College or Higher"),
  Count = c(demo_nohs_count, demo_hs_count, demo_scoh_count),
  Proportion = c(demo_nohs_prop, demo_hs_prop, demo_scoh_prop)
)

# finally, lets display our table
gt(demo_education_table_df, rowname_col = "Level") |>
    tab_header(
    title = md("**Income-to-Poverty Ratio**")
  )

# again, lets follow the same logic as above, but now for the income levels
# first, we determine the counts per income level
demo_income_table <- table(income_bmi$income)
demo_under_20_income_count <- demo_income_table[1]
demo_from_20_44_income_count <- demo_income_table[2]
demo_from_45_75_income_count <- demo_income_table[3]
demo_from_75_99_income_count <- demo_income_table[4]
demo_over_100_income_count <- demo_income_table[5]

# next, we determine the proportion per income level
demo_income_prop <- prop.table(demo_income_table)
demo_under_20_income_prop <- round(demo_income_prop[1], 2)
demo_from_20_44_income_prop <- round(demo_income_prop[2], 2)
demo_from_45_75_income_prop <- round(demo_income_prop[3], 2)
demo_from_75_99_income_prop <- round(demo_income_prop[4], 2)
demo_over_100_income_prop <- round(demo_income_prop[5], 2)

# lets put this data into a data frame
demo_income_table_df <- data.frame(
  Level = c("< $20,000", "$20,000-$44,999", "$45,000-$74,999", "$75,000-$99,999", "> $100,000"),
  Count = c(demo_under_20_income_count, 
            demo_from_20_44_income_count, 
            demo_from_45_75_income_count, 
            demo_from_75_99_income_count, 
            demo_over_100_income_count),
  Proportion = c(demo_under_20_income_prop, 
            demo_from_20_44_income_prop, 
            demo_from_45_75_income_prop, 
            demo_from_75_99_income_prop, 
            demo_over_100_income_prop)
)

# now we display the table using gt()
gt(demo_income_table_df, rowname_col = "Level") |>
    tab_header(
    title = md("**Income Level**")
  )

# finally, lets do the counts per income-to-poverty ratio levels
demo_ratio_table <- table(ratio_bmi$ratio)
demo_low_income_ratio_count <- demo_ratio_table[1]
demo_medium_income_ratio_count <- demo_ratio_table[2]
demo_high_income_ratio_count <- demo_ratio_table[3]

# proportions per income-to-poverty ratio levels
demo_ratio_prop <- prop.table(demo_ratio_table)
demo_low_income_ratio_prop <- round(demo_ratio_prop[1], 2)
demo_medium_income_ratio_prop <- round(demo_ratio_prop[2], 2)
demo_high_income_ratio_prop <- round(demo_ratio_prop[3], 2)

# income-to-poverty ratio levels summary df
demo_ratio_table_df <- data.frame(
  Level = c("Low Income", "Medium Income", "High Income"),
  Count = c(demo_low_income_ratio_count, 
            demo_medium_income_ratio_count, 
            demo_high_income_ratio_count),
  Proportion = c(demo_low_income_ratio_prop, 
            demo_medium_income_ratio_prop, 
            demo_high_income_ratio_prop)
)

# income-to-poverty ratio levels summary table
gt(demo_ratio_table_df, rowname_col = "Level") |>
    tab_header(
    title = md("**Education Level**")
  )
```

## Calculate Disease Prevalence

```{r}
# next, lets calculate the obesity disease prevalence across levels for each socioeconomic factor
# this is a key analysis step in our project and will be the main value we use to compare
# across socioeconomic levels
# we will calculate the disease prevalence by dividing the number of subjects with obesity 
# by the total number of subjects, per socioeconomic status (e.g,, low income, 
# medium income, high income)
# we will then save these values into a new df, which will be used for our visualizations

cat("------- Obesity Disease Prevalence: Overall Population -------") # divider, purely aesthetic
# first, lets calculate the overall obesity disease prevalence for the population as a whole
round(sum(ratio_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(!is.na(ratio_bmi$bmi_cat), na.rm = TRUE), 2)


cat("------- Obesity Disease Prevalence: Income Ratio -------") # divider, purely aesthetic
# now, lets calculate the obesity disease prevalence per income-to-poverty ratio level
low_income <- round(sum(ratio_bmi$ratio_cat == "Low Income" & ratio_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(ratio_bmi$ratio_cat == "Low Income", na.rm = TRUE), 2)
medium_income <- round(sum(ratio_bmi$ratio_cat == "Medium Income" & ratio_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(ratio_bmi$ratio_cat == "Medium Income", na.rm = TRUE), 2)
high_income <- round(sum(ratio_bmi$ratio_cat == "High Income" & ratio_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(ratio_bmi$ratio_cat == "High Income", na.rm = TRUE), 2)

# lets take a quic look at the results
cat(paste("\nLow Income:", low_income))
cat(paste("\nMedium Income:", medium_income))
cat(paste("\nHigh Income:", high_income))


low_income_male <- round(sum(ratio_bmi$ratio_cat == "Low Income" & ratio_bmi$gender == "Male" & ratio_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(ratio_bmi$ratio_cat == "Low Income" & ratio_bmi$gender == "Male", na.rm = TRUE), 2)
medium_income_male <- round(sum(ratio_bmi$ratio_cat == "Medium Income" & ratio_bmi$gender == "Male" & ratio_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(ratio_bmi$ratio_cat == "Medium Income" & ratio_bmi$gender == "Male", na.rm = TRUE), 2)
high_income_male <- round(sum(ratio_bmi$ratio_cat == "High Income" & ratio_bmi$gender == "Male" & ratio_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(ratio_bmi$ratio_cat == "High Income"& ratio_bmi$gender == "Male", na.rm = TRUE), 2)

# lets take a quick look at the results
cat(paste("\n\nLow Income Male:", low_income_male))
cat(paste("\nMedium Income Male:", medium_income_male))
cat(paste("\nHigh Income Male:", high_income_male))

low_income_female <- round(sum(ratio_bmi$ratio_cat == "Low Income" & ratio_bmi$gender == "Female" & ratio_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(ratio_bmi$ratio_cat == "Low Income" & ratio_bmi$gender == "Female", na.rm = TRUE), 2)
medium_income_female <- round(sum(ratio_bmi$ratio_cat == "Medium Income" & ratio_bmi$gender == "Female" & ratio_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(ratio_bmi$ratio_cat == "Medium Income" & ratio_bmi$gender == "Female", na.rm = TRUE), 2)
high_income_female <- round(sum(ratio_bmi$ratio_cat == "High Income" & ratio_bmi$gender == "Female" & ratio_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(ratio_bmi$ratio_cat == "High Income"& ratio_bmi$gender == "Female", na.rm = TRUE), 2)

# lets take a quick look at the results
cat(paste("\n\nLow Income Female:", low_income_female))
cat(paste("\nMedium Income Female:", medium_income_female))
cat(paste("\nHigh Income Female:", high_income_female))

# now lets save it to a new df, so we can use it in our visuals (and maybe tables, tbd)
# we will also use a factor here, so we can define the order we wish to display the 
# categories in the plots (low ses to high ses)
ratio_prevalence <- data.frame(
  ratio_level = factor(c("Low Income", "Medium Income", "High Income"), levels = c("Low Income", "Medium Income", "High Income")),
  disease_prevalance = c(low_income, medium_income, high_income),
  male = c(low_income_male, medium_income_male, high_income_male),
  female = c(low_income_female, medium_income_female, high_income_female)
)

cat("\n\n------- Obesity Disease Prevalence: Income -------") # divider, purely aesthetic
# second, lets calculate the obesity disease prevalence per income level
under_20_income <- round(sum(income_bmi$income == "< $20,000" & income_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(income_bmi$income == "< $20,000", na.rm = TRUE), 2)
from_20_44_income <- round(sum(income_bmi$income == "$20,000-$44,999" & income_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(income_bmi$income == "$20,000-$44,999", na.rm = TRUE), 2)
from_45_75_income <- round(sum(income_bmi$income == "$45,000-$74,999" & income_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(income_bmi$income == "$45,000-$74,999", na.rm = TRUE), 2)
from_75_99_income <- round(sum(income_bmi$income == "$75,000-$99,999" & income_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(income_bmi$income == "$75,000-$99,999", na.rm = TRUE), 2)
over_100_income <- round(sum(income_bmi$income == "> $100,000" & income_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(income_bmi$income == "> $100,000", na.rm = TRUE), 2)

# lets take a quick look at the results
cat(paste("\n< $20,000:", under_20_income))
cat(paste("\n$20,000-$44,999:", from_20_44_income))
cat(paste("\n$45,000-$74,999:", from_45_75_income))
cat(paste("\n$75,000-$99,999:", from_75_99_income))
cat(paste("\n> $100,000:", over_100_income))

under_20_income_male <- round(sum(income_bmi$income == "< $20,000" & income_bmi$gender == "Male" & income_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(income_bmi$income == "< $20,000" & income_bmi$gender == "Male", na.rm = TRUE), 2)
from_20_44_income_male <- round(sum(income_bmi$income == "$20,000-$44,999" & income_bmi$gender == "Male" & income_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(income_bmi$income == "$20,000-$44,999" & income_bmi$gender == "Male", na.rm = TRUE), 2)
from_45_75_income_male <- round(sum(income_bmi$income == "$45,000-$74,999" & income_bmi$gender == "Male" & income_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(income_bmi$income == "$45,000-$74,999" & income_bmi$gender == "Male", na.rm = TRUE), 2)
from_75_99_income_male <- round(sum(income_bmi$income == "$75,000-$99,999" & income_bmi$gender == "Male" & income_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(income_bmi$income == "$75,000-$99,999" & income_bmi$gender == "Male", na.rm = TRUE), 2)
over_100_income_male <- round(sum(income_bmi$income == "> $100,000" & income_bmi$gender == "Male" & income_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(income_bmi$income == "> $100,000" & income_bmi$gender == "Male", na.rm = TRUE), 2)

# lets take a quick look at the results
cat(paste("\n\n< $20,000 Male:", under_20_income_male))
cat(paste("\n$20,000-$44,999 Male:", from_20_44_income_male))
cat(paste("\n$45,000-$74,999 Male:", from_45_75_income_male))
cat(paste("\n$75,000-$99,999 Male:", from_75_99_income_male))
cat(paste("\n> $100,000 Male:", over_100_income_male))

under_20_income_female <- round(sum(income_bmi$income == "< $20,000" & income_bmi$gender == "Female" & income_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(income_bmi$income == "< $20,000" & income_bmi$gender == "Female", na.rm = TRUE), 2)
from_20_44_income_female <- round(sum(income_bmi$income == "$20,000-$44,999" & income_bmi$gender == "Female" & income_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(income_bmi$income == "$20,000-$44,999" & income_bmi$gender == "Female", na.rm = TRUE), 2)
from_45_75_income_female <- round(sum(income_bmi$income == "$45,000-$74,999" & income_bmi$gender == "Female" & income_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(income_bmi$income == "$45,000-$74,999" & income_bmi$gender == "Female", na.rm = TRUE), 2)
from_75_99_income_female <- round(sum(income_bmi$income == "$75,000-$99,999" & income_bmi$gender == "Female" & income_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(income_bmi$income == "$75,000-$99,999" & income_bmi$gender == "Female", na.rm = TRUE), 2)
over_100_income_female <- round(sum(income_bmi$income == "> $100,000" & income_bmi$gender == "Female" & income_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(income_bmi$income == "> $100,000" & income_bmi$gender == "Female", na.rm = TRUE), 2)

# lets take a quick look at the results
cat(paste("\n\n< $20,000 Female:", under_20_income_female))
cat(paste("\n$20,000-$44,999 Female:", from_20_44_income_female))
cat(paste("\n$45,000-$74,999 Female:", from_45_75_income_female))
cat(paste("\n$75,000-$99,999 Female:", from_75_99_income_female))
cat(paste("\n> $100,000 Female:", over_100_income_female))

# now we can save it to a df to use in our visuals
income_prevalence <- data.frame(
  income_level = factor(c("< $20,000", "$20,000-$44,999", "$45,000-$74,999", "$75,000-$99,999", "> $100,000"),  levels = c("< $20,000", "$20,000-$44,999", "$45,000-$74,999", "$75,000-$99,999", "> $100,000")),
  disease_prevalance = c(under_20_income, from_20_44_income, from_45_75_income, from_75_99_income, over_100_income),
  male = c(under_20_income_male, from_20_44_income_male, from_45_75_income_male, from_75_99_income_male, over_100_income_male),
  female = c(under_20_income_female, from_20_44_income_female, from_45_75_income_female, from_75_99_income_female, over_100_income_female)
)

cat("\n\n------- Obesity Disease Prevalence: Education -------") # divider, purely aesthetic
# second, lets calculate the obesity disease prevalence per education level
no_hs <- round(sum(education_bmi$education == "Non-High School Graduate" & education_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(education_bmi$education == "Non-High School Graduate", na.rm = TRUE), 2)
hs <- round(sum(education_bmi$education == "High School Graduate" & education_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(education_bmi$education == "High School Graduate", na.rm = TRUE), 2)
above_hs <- round(sum(education_bmi$education == "Some College or Higher" & education_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(education_bmi$education == "Some College or Higher", na.rm = TRUE), 2)

# lets take a quick look at the results
cat(paste("\nNon-High School Graduate:", no_hs))
cat(paste("\nHigh School Graduate:", hs))
cat(paste("\nSome College or Higher:", above_hs))

no_hs_male <- round(sum(education_bmi$education == "Non-High School Graduate" & education_bmi$gender == "Male" & education_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(education_bmi$education == "Non-High School Graduate" & education_bmi$gender == "Male", na.rm = TRUE), 2)
hs_male <- round(sum(education_bmi$education == "High School Graduate" & education_bmi$gender == "Male" & education_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(education_bmi$education == "High School Graduate" & education_bmi$gender == "Male", na.rm = TRUE), 2)
above_hs_male <- round(sum(education_bmi$education == "Some College or Higher" & education_bmi$gender == "Male" & education_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(education_bmi$education == "Some College or Higher" & education_bmi$gender == "Male", na.rm = TRUE), 2)

# lets take a quick look at the results
cat(paste("\n\nNon-High School Graduate Male:", no_hs_male))
cat(paste("\nHigh School Graduate Male:", hs_male))
cat(paste("\nSome College or Higher Male:", above_hs_male))

no_hs_female <- round(sum(education_bmi$education == "Non-High School Graduate" & education_bmi$gender == "Female" & education_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(education_bmi$education == "Non-High School Graduate" & education_bmi$gender == "Female", na.rm = TRUE), 2)
hs_female <- round(sum(education_bmi$education == "High School Graduate" & education_bmi$gender == "Female" & education_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(education_bmi$education == "High School Graduate" & education_bmi$gender == "Female", na.rm = TRUE), 2)
above_hs_female <- round(sum(education_bmi$education == "Some College or Higher" & education_bmi$gender == "Female" & education_bmi$bmi_cat == "Obesity", na.rm = TRUE) / sum(education_bmi$education == "Some College or Higher" & education_bmi$gender == "Female", na.rm = TRUE), 2)

# lets take a quick look at the results
cat(paste("\n\nNon-High School Graduate Female:", no_hs_female))
cat(paste("\nHigh School Graduate Female:", hs_female))
cat(paste("\nSome College or Higher Female:", above_hs_female))

# again, we will save it to a new df to use in our plots
education_prevalence <- data.frame(
  education_level = factor(c("Non-High School Graduate", "High School Graduate", "Some College or Higher"), levels = c("Non-High School Graduate", "High School Graduate", "Some College or Higher")),
  disease_prevalance = c(no_hs, hs, above_hs),
  male = c(no_hs_male, hs_male, above_hs_male),
  female = c(no_hs_female, hs_female, above_hs_female)
)
```

## Visualzation: Disease Prevalence by Income-to-Poverty Ratio

```{r}
# to visualize the obesity disease prevalence across income-to-poverty ratio levels
# we will use a bar chart with points + lines to better visualize the trends
# lets also include text showing the specific disease prevalence values for each level
# referenced https://r-graph-gallery.com/275-add-text-labels-with-ggplot2.html for 
# how to add the geom_text values to the plots
ratio_obesity_disease_prevalence <-
  ggplot(ratio_prevalence, aes(x = ratio_level, y = disease_prevalance, fill = ratio_level, group = 1)) +
  geom_col(alpha = alpha) + # for the bar charts
  geom_point(size = size) + # for the individual points
  geom_line(linetype = linetype) + # for the trend lines between points
  geom_text(aes(label = disease_prevalance), nudge_y = nudge_y) + # for the specific values
  scale_y_continuous(limits = c(0, 0.5)) + # setting y to 0.5 seemed intuitive
  scale_fill_lotr_d(prevalence_palette) + # lets use my custom polette
  labs( # the rest is just aesthetics and making the plot more clean + readable
    title = "Obesity Prevalence by Income-to-Poverty Ratio", 
    x = "Income-to-Poverty Ratio", 
    y = "Obesity Prevalence"
  ) +
  theme( 
    text = element_text(size = 8), 
    axis.title = element_text(size = 10, face = "bold"), 
    axis.text = element_text(size = 8), 
    plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
    panel.background = element_rect(fill = "#F5F5F5"),
    legend.position = "none"
  )

ratio_obesity_disease_prevalence

# ggsave("plots/ratio_obesity_disease_prevalence.png", plot = ratio_obesity_disease_prevalence, width = 6, height = 4, units = "in", dpi = 300)

ratio_obesity_disease_prevalence_male <-
  ggplot(ratio_prevalence, aes(x = ratio_level, y = male, fill = ratio_level, group = 1)) +
  geom_col(alpha = alpha) + # for the bar charts
  geom_point(size = size) + # for the individual points
  geom_line(linetype = linetype) + # for the trend lines between points
  geom_text(aes(label = male), nudge_y = nudge_y) + # for the specific values
  scale_y_continuous(limits = c(0, 0.5)) + # setting y to 0.5 seemed intuitive
  scale_fill_lotr_d(prevalence_palette) + # lets use my custom polette
  labs( # the rest is just aesthetics and making the plot more clean + readable
    title = "Obesity Prevalence by Income-to-Poverty Ratio - Male Only", 
    x = "Income-to-Poverty Ratio", 
    y = "Obesity Prevalence"
  ) +
  theme( 
    text = element_text(size = 8), 
    axis.title = element_text(size = 10, face = "bold"), 
    axis.text = element_text(size = 8), 
    plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
    panel.background = element_rect(fill = "#F5F5F5"),
    legend.position = "none"
  )

ratio_obesity_disease_prevalence_male

# ggsave("plots/ratio_obesity_disease_prevalence_male.png", plot = ratio_obesity_disease_prevalence_male, width = 6, height = 4, units = "in", dpi = 300)

ratio_obesity_disease_prevalence_female <-
  ggplot(ratio_prevalence, aes(x = ratio_level, y = female, fill = ratio_level, group = 1)) +
  geom_col(alpha = alpha) + # for the bar charts
  geom_point(size = size) + # for the individual points
  geom_line(linetype = linetype) + # for the trend lines between points
  geom_text(aes(label = female), nudge_y = nudge_y) + # for the specific values
  scale_y_continuous(limits = c(0, 0.51)) + # setting y to 0.5 seemed intuitive
  scale_fill_lotr_d(prevalence_palette) + # lets use my custom polette
  labs( # the rest is just aesthetics and making the plot more clean + readable
    title = "Obesity Prevalence by Income-to-Poverty Ratio - Female Only", 
    x = "Income-to-Poverty Ratio", 
    y = "Obesity Prevalence"
  ) +
  theme( 
    text = element_text(size = 8), 
    axis.title = element_text(size = 10, face = "bold"), 
    axis.text = element_text(size = 8), 
    plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
    panel.background = element_rect(fill = "#F5F5F5"),
    legend.position = "none"
  )

ratio_obesity_disease_prevalence_female

# ggsave("plots/ratio_obesity_disease_prevalence_female.png", plot = ratio_obesity_disease_prevalence_female, width = 6, height = 4, units = "in", dpi = 300)
```

## Visualzation: Disease Prevalence by Education Level

```{r}
# next, we will visualize the obesity disease prevalence across education levels
# for visual consistency, we will again use a bar chart with points + lines + text values
education_obesity_disease_prevalence <-
  ggplot(education_prevalence, aes(x = education_level, y = disease_prevalance, fill = education_level, group = 1)) +
  geom_col(alpha = alpha) + # the main bar chart
  geom_point(size = size) + # plot points
  geom_line(linetype = linetype) + # trend lines between the points
  geom_text(aes(label = disease_prevalance), nudge_y = nudge_y) + # text displays the prevalence values
  scale_y_continuous(limits = c(0, 0.5)) + # lets use the same y scale
  scale_fill_lotr_d(prevalence_palette) + # again, lets use the same color palette
  labs( # the rest is aesthetics + cleanup
    title = "Obesity Prevalence by Education Level", 
    x = "Education Level", 
    y = "Obesity Prevalence"
  ) +
  theme(
    text = element_text(size = 8), 
    axis.title = element_text(size = 10, face = "bold"), 
    axis.text = element_text(size = 8), 
    plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
    panel.background = element_rect(fill = "#F5F5F5"),
    legend.position = "none"
  )

education_obesity_disease_prevalence

# ggsave("plots/education_obesity_disease_prevalence.png", plot = education_obesity_disease_prevalence, width = 6, height = 4, units = "in", dpi = 300)

education_obesity_disease_prevalence_male <-
  ggplot(education_prevalence, aes(x = education_level, y = male, fill = education_level, group = 1)) +
  geom_col(alpha = alpha) + # the main bar chart
  geom_point(size = size) + # plot points
  geom_line(linetype = linetype) + # trend lines between the points
  geom_text(aes(label = male), nudge_y = nudge_y) + # text displays the prevalence values
  scale_y_continuous(limits = c(0, 0.5)) + # lets use the same y scale
  scale_fill_lotr_d(prevalence_palette) + # again, lets use the same color palette
  labs( # the rest is aesthetics + cleanup
    title = "Obesity Prevalence by Education Level - Male Only", 
    x = "Education Level", 
    y = "Obesity Prevalence"
  ) +
  theme(
    text = element_text(size = 8), 
    axis.title = element_text(size = 10, face = "bold"), 
    axis.text = element_text(size = 8), 
    plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
    panel.background = element_rect(fill = "#F5F5F5"),
    legend.position = "none"
  )

education_obesity_disease_prevalence_male

# ggsave("plots/education_obesity_disease_prevalence_male.png", plot = education_obesity_disease_prevalence_male, width = 6, height = 4, units = "in", dpi = 300)

education_obesity_disease_prevalence_female <-
  ggplot(education_prevalence, aes(x = education_level, y = female, fill = education_level, group = 1)) +
  geom_col(alpha = alpha) + # the main bar chart
  geom_point(size = size) + # plot points
  geom_line(linetype = linetype) + # trend lines between the points
  geom_text(aes(label = female), nudge_y = nudge_y) + # text displays the prevalence values
  scale_y_continuous(limits = c(0, 0.5)) + # lets use the same y scale
  scale_fill_lotr_d(prevalence_palette) + # again, lets use the same color palette
  labs( # the rest is aesthetics + cleanup
    title = "Obesity Prevalence by Education Level - Female Only", 
    x = "Education Level", 
    y = "Obesity Prevalence"
  ) +
  theme(
    text = element_text(size = 8), 
    axis.title = element_text(size = 10, face = "bold"), 
    axis.text = element_text(size = 8), 
    plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
    panel.background = element_rect(fill = "#F5F5F5"),
    legend.position = "none"
  )

education_obesity_disease_prevalence_female

# ggsave("plots/education_obesity_disease_prevalence_female.png", plot = education_obesity_disease_prevalence_female, width = 6, height = 4, units = "in", dpi = 300)
```

## Visualzation: Disease Prevalence by Income Level

```{r}
# now, we will visualize the obesity disease prevalence across income levels
# agaiin for consistency, lets use the bar chart with points + lines + prevalence text values
income_obesity_disease_prevalence <-
  ggplot(income_prevalence, aes(x = income_level, y = disease_prevalance, fill = income_level, group = 1)) +
  geom_col(alpha = alpha) + # bar charts
  geom_point(size = size) + # plot points
  geom_line(linetype = linetype) + # trend lines
  geom_text(aes(label = disease_prevalance), nudge_y = nudge_y) + # prevalence values
  scale_y_continuous(limits = c(0, 0.5)) + # y scale, for consistency
  scale_fill_lotr_d(prevalence_palette) + # custom palette, for consistency
  labs( # use the same labels + theme format, for consistency
    title = "Obesity Prevalence by Income", 
    x = "Income", 
    y = "Obesity Prevalence"
  ) +
  theme(
    text = element_text(size = 8), 
    axis.title = element_text(size = 10, face = "bold"), 
    axis.text = element_text(size = 8), 
    plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
    panel.background = element_rect(fill = "#F5F5F5"),
    legend.position = "none"
  )

income_obesity_disease_prevalence

# ggsave("plots/income_obesity_disease_prevalence.png", plot = income_obesity_disease_prevalence, width = 6, height = 4, units = "in", dpi = 300)

income_obesity_disease_prevalence_male <-
  ggplot(income_prevalence, aes(x = income_level, y = male, fill = income_level, group = 1)) +
  geom_col(alpha = alpha) + # bar charts
  geom_point(size = size) + # plot points
  geom_line(linetype = linetype) + # trend lines
  geom_text(aes(label = male), nudge_y = nudge_y) + # prevalence values
  scale_y_continuous(limits = c(0, 0.5)) + # y scale, for consistency
  scale_fill_lotr_d(prevalence_palette) + # custom palette, for consistency
  labs( # use the same labels + theme format, for consistency
    title = "Obesity Prevalence by Income - Male Only", 
    x = "Income", 
    y = "Obesity Prevalence"
  ) +
  theme(
    text = element_text(size = 8), 
    axis.title = element_text(size = 10, face = "bold"), 
    axis.text = element_text(size = 8), 
    plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
    panel.background = element_rect(fill = "#F5F5F5"),
    legend.position = "none"
  )

income_obesity_disease_prevalence_male

# ggsave("plots/income_obesity_disease_prevalence_male.png", plot = income_obesity_disease_prevalence_male, width = 6, height = 4, units = "in", dpi = 300)

income_obesity_disease_prevalence_female <-
  ggplot(income_prevalence, aes(x = income_level, y = female, fill = income_level, group = 1)) +
  geom_col(alpha = alpha) + # bar charts
  geom_point(size = size) + # plot points
  geom_line(linetype = linetype) + # trend lines
  geom_text(aes(label = female), nudge_y = nudge_y) + # prevalence values
  scale_y_continuous(limits = c(0, 0.5)) + # y scale, for consistency
  scale_fill_lotr_d(prevalence_palette) + # custom palette, for consistency
  labs( # use the same labels + theme format, for consistency
    title = "Obesity Prevalence by Income - Female Only", 
    x = "Income", 
    y = "Obesity Prevalence"
  ) +
  theme(
    text = element_text(size = 8), 
    axis.title = element_text(size = 10, face = "bold"), 
    axis.text = element_text(size = 8), 
    plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
    panel.background = element_rect(fill = "#F5F5F5"),
    legend.position = "none"
  )

income_obesity_disease_prevalence_female

# ggsave("plots/income_obesity_disease_prevalence_female.png", plot = income_obesity_disease_prevalence_female, width = 6, height = 4, units = "in", dpi = 300)
```
## Visualzation: Age Distribution by Income-to-Povert Ratio

```{r}
# i think it is also important to highlight a key confounder that may also
# be contributing to the disease prevalance, and be correlated with different
# socioeconomic statuses: age
# for each of our three socioeconomic factors (income to poverty ratio, education
# and income), lets visualize how age is distributed across the levels

# to do this, lets use ggplot and create boxplots of the age distribution
# for each income-to-poverty ratio category
ratio_age_distribution <- ggplot(ratio_bmi, aes(x = ratio_cat, y = age, fill = ratio_cat)) +
  geom_boxplot(alpha = alpha) + # for our boxplot
  scale_fill_lotr_d(age_distribution_palette) + # for our custom palette
  labs( # lets give the plot proper labels and themes
    title = "Age Distribution by Income Ratio", 
    x = "Income Ratio", 
    y = "Age"
  ) +
  theme(
    text = element_text(size = 8), 
    axis.title = element_text(size = 10, face = "bold"), 
    axis.text = element_text(size = 8), 
    plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
    panel.background = element_rect(fill = "#F5F5F5"),
    legend.position = "none"
  )

ratio_age_distribution

# ggsave("plots/ratio_age_distribution.png", plot = ratio_age_distribution, width = 6, height = 4, units = "in", dpi = 300)
```

## Visualzation: Age Distribution by Income Level

```{r}
# next, lets visualize the distribution of age across income levels
# again, using a boxplot with similar styling/aesthetics for consistency
income_age_distribution <- ggplot(income_bmi, aes(x = income, y = age, fill = income)) +
  geom_boxplot(alpha = alpha) +
  scale_fill_lotr_d(age_distribution_palette) +
  labs(
    title = "Age Distribution by Income", 
    x = "Income", 
    y = "Age"
  ) +
  theme(
    text = element_text(size = 8), 
    axis.title = element_text(size = 10, face = "bold"), 
    axis.text = element_text(size = 8), 
    plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
    panel.background = element_rect(fill = "#F5F5F5"),
    legend.position = "none"
  )

income_age_distribution

# ggsave("plots/income_age_distribution.png", plot = income_age_distribution, width = 8, height = 4, units = "in", dpi = 300)
```

## Visualzation: Age Distribution by Education Level

```{r}
# finally, lets visualize the age distrubtion across education levels
education_age_distribution <- ggplot(education_bmi, aes(x = education, y = age, fill = education)) +
  geom_boxplot(alpha = alpha) +
  scale_fill_lotr_d(age_distribution_palette) +
  labs(
    title = "Age Distribution by Education", 
    x = "Education", 
    y = "Age"
  ) +
  theme(
    text = element_text(size = 8), 
    axis.title = element_text(size = 10, face = "bold"), 
    axis.text = element_text(size = 8), 
    plot.title = element_text(size = 12, hjust = 0.5, face = "bold"),
    panel.background = element_rect(fill = "#F5F5F5"),
    legend.position = "none"
  )

education_age_distribution

# ggsave("plots/education_age_distribution.png", plot = education_age_distribution, width = 6, height = 4, units = "in", dpi = 300)
```

